<div class="form-container" style="padding: 24px;">
    <mat-card>
        <mat-card-header>
            <mat-card-title>{{ isEditMode ? 'Modificar Micro' : 'Agregar Micro' }}</mat-card-title>
        </mat-card-header>

        <mat-card-content>
            <form [formGroup]="busForm" (ngSubmit)="save()">
                <!-- Fila 1: Patente y Marca -->
                <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <mat-form-field appearance="outline" style="width: 100%;">
                        <mat-label>Patente</mat-label>
                        <input matInput formControlName="plate" [readonly]="isEditMode"
                            placeholder="XXX-000 o XX 000 XX" />
                        @if(busForm.get('plate')?.hasError('required'))
                        {
                        <mat-error>
                            La Patente es obligatoria
                        </mat-error>
                        }
                        @if(busForm.get('plate')?.hasError('pattern'))
                        {
                        <mat-error>
                            Los formatos permitidos son: XXX-000 o XX 000 XX
                        </mat-error>
                        }
                    </mat-form-field>

                    <mat-form-field appearance="outline" style="width: 100%;">
                        <mat-label>Marca</mat-label>
                        <input matInput formControlName="brand" />
                    </mat-form-field>
                </div>

                <!-- Fila 2: Asignación del chofer -->
                <div formGroupName="driver">
                    <fieldset style="padding: 16px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 24px;">
                        <legend style="font-weight: bold;">Datos del Chofer</legend>
                        <!-- Fila 1: combo del dni -->
                        <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <!-- Combo de DNI -->
                            <mat-form-field appearance="outline" style="width: 100%;">
                                <mat-label>Chofer</mat-label>
                                <mat-select formControlName="id" (selectionChange)="onDriverChange($event.value)">
                                    @for (item of driversList; track $index)
                                    {
                                    <mat-option [value]="item.id">
                                        {{ item.dni }}
                                    </mat-option>
                                    }
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <!-- Fila 2: apellidos y nombres -->
                        <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <!-- Apellido (solo lectura) -->
                            <mat-form-field appearance="outline" style="width: 100%;">
                                <mat-label>Apellido</mat-label>
                                <input matInput formControlName="lastName" readonly>
                            </mat-form-field>

                            <!-- Nombre (solo lectura) -->
                            <mat-form-field appearance="outline" style="width: 100%;">
                                <mat-label>Nombre</mat-label>
                                <input matInput formControlName="firstName" readonly>
                            </mat-form-field>
                        </div>
                    </fieldset>
                </div>

                <!-- Fila 3: Asignación de los chicos -->
                <fieldset style="padding: 16px; border: 1px solid #ccc; border-radius: 4px;">
                    <legend style="font-weight: bold;">Datos de los Chicos</legend>

                    <div class="table-container" style="overflow-x: auto;">
                        <table mat-table [dataSource]="boysList" class="mat-elevation-z8"
                            style="width: 100%; min-width: 700px;">
                            <!-- ID Column -->
                            <ng-container matColumnDef="id">
                                <th mat-header-cell *matHeaderCellDef>ID</th>
                                <td mat-cell *matCellDef="let element">{{ element.id }}</td>
                            </ng-container>

                            <!-- DNI Column -->
                            <ng-container matColumnDef="dni">
                                <th mat-header-cell *matHeaderCellDef>DNI</th>
                                <td mat-cell *matCellDef="let element">{{ element.dni }}</td>
                            </ng-container>

                            <!-- Apellidos Column -->
                            <ng-container matColumnDef="apellidos">
                                <th mat-header-cell *matHeaderCellDef>Apellidos</th>
                                <td mat-cell *matCellDef="let element">{{ element.lastName }}</td>
                            </ng-container>

                            <!-- Nombres Column -->
                            <ng-container matColumnDef="nombres">
                                <th mat-header-cell *matHeaderCellDef>Nombres</th>
                                <td mat-cell *matCellDef="let element">{{ element.firstName }}</td>
                            </ng-container>

                            <!-- Sexo Column -->
                            <ng-container matColumnDef="sexo">
                                <th mat-header-cell *matHeaderCellDef>Sexo</th>
                                <td mat-cell *matCellDef="let element">{{ element.gender }}</td>
                            </ng-container>

                            <!-- Edad Column -->
                            <ng-container matColumnDef="edad">
                                <th mat-header-cell *matHeaderCellDef>Edad</th>
                                <td mat-cell *matCellDef="let element">{{ element.age }}</td>
                            </ng-container>

                            <!-- Asignado Column -->
                            <ng-container matColumnDef="asignado">
                                <th mat-header-cell *matHeaderCellDef>Assigned</th>
                                <td mat-cell *matCellDef="let element">
                                    <mat-checkbox [checked]="element.assigned"></mat-checkbox>
                                </td>
                            </ng-container>

                            <!-- Header y Rows -->
                            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                        </table>
                    </div>
                </fieldset>

                <!-- Botón -->
                <div style="text-align: end; margin-top: 16px;">
                    <button mat-raised-button color="primary" type="submit">
                        {{ isEditMode ? 'Actualizar' : 'Agregar' }}
                    </button>
                </div>
            </form>
        </mat-card-content>

        @if (error)
        {
        <p class="error-text">{{ error }}</p>
        }
    </mat-card>
</div>